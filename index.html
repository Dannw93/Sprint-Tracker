<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts for Charts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            overscroll-behavior-y: contain;
        }
        .prose { max-width: 65ch; color: #374151; }
        .prose h1, .prose h2, .prose h3 { color: #111827; }
        .prose strong { color: #111827; }
        .prose ul > li::before { background-color: #3b82f6; }
        
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f3f4f6;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
            border: 2px solid #f3f4f6;
        }
        .range-thumb::-webkit-slider-thumb{
            -webkit-appearance:none;
            appearance:none;
            width:24px;
            height:24px;
            background:#3b82f6;
            cursor:pointer;
            border-radius:50%;
            border: 4px solid #fff;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        .range-thumb::-moz-range-thumb{
            width:24px;
            height:24px;
            background:#3b82f6;
            cursor:pointer;
            border-radius:50%;
            border: 4px solid #fff;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        try {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js");
            const { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js");
            const { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove, setLogLevel } = await import("https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js");

            window.firebase = {
                initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
                signInWithCustomToken, getFirestore, collection, addDoc, query,
                onSnapshot, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove, setLogLevel,
            };
        } catch (e) {
            console.warn("Could not load Firebase modules. The app will run in offline mode.", e);
            window.firebase = null; 
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const apiKey = ""; 
        async function callGemini(prompt) {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
          const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
          try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) { return result.candidates[0].content.parts[0].text; }
            console.error("Unexpected response structure:", result);
            return "Could not get a response from the AI.";
          } catch (error) {
            console.error("Error calling Gemini API:", error);
            return `An error occurred: ${error.message}`;
          }
        }

        function Icon({ name, size = 16, className = "" }) {
            const iconStyle = { width: size, height: size, strokeWidth: 2, stroke: 'currentColor', fill: 'none', strokeLinecap: 'round', strokeLinejoin: 'round' };
            const icons = {
                plus: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
                check: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><polyline points="20 6 9 17 4 12"></polyline></svg>,
                x: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
                menu: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
                logIn: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>,
                chevronDown: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><polyline points="6 9 12 15 18 9"></polyline></svg>,
                chevronUp: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><polyline points="18 15 12 9 6 15"></polyline></svg>,
                trash2: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
                edit: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
                save: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
                alertTriangle: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
                chevronLeft: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><polyline points="15 18 9 12 15 6"></polyline></svg>,
                chevronRight: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><polyline points="9 18 15 12 9 6"></polyline></svg>,
                zap: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
                brainCircuit: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style={iconStyle}><path d="M12 2a2.5 2.5 0 0 0-2.5 2.5v.5a2.5 2.5 0 0 0 5 0v-.5A2.5 2.5 0 0 0 12 2Z M7.5 7.5a2.5 2.5 0 0 0 0 5M16.5 7.5a2.5 2.5 0 0 0 0 5m-9 6a2.5 2.5 0 0 0 5 0m4 0a2.5 2.5 0 0 0 5 0M4.5 4.5a2.5 2.5 0 0 0-2 4v.5a2.5 2.5 0 0 0 2 4M19.5 4.5a2.5 2.5 0 0 1 2 4v.5a2.5 2.5 0 0 1-2 4m-10 6a2.5 2.5 0 0 0-2 4v.5a2.5 2.5 0 0 0 2 4m5 0a2.5 2.5 0 0 0-2 4v.5a2.5 2.5 0 0 0 2 4M7 15h.5a2.5 2.5 0 0 0 4 0h1a2.5 2.5 0 0 0 4 0h.5M7 9h.5a2.5 2.5 0 0 0 4 0h1a2.5 2.5 0 0 0 4 0H17M9.5 7V5.5a2.5 2.5 0 0 0-4-2.5M14.5 7V5.5a2.5 2.5 0 0 1 4-2.5"></path></svg>,
            };
            return <span className={className}>{icons[name]}</span>;
        }

        function App() {
          const [user, setUser] = useState(null);
          const [db, setDb] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [isOffline, setIsOffline] = useState(false);

          useEffect(() => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const firebase = window.firebase;
            if (!firebase || !firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                setIsOffline(true);
                setIsAuthReady(true);
                return;
            }
            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, setLogLevel } = firebase;
            try {
              const app = initializeApp(firebaseConfig);
              const authInstance = getAuth(app);
              setDb(getFirestore(app));
              setLogLevel('debug');
              onAuthStateChanged(authInstance, async (currentUser) => {
                if (currentUser) { setUser(currentUser); } 
                else {
                  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                  if (initialAuthToken) {
                    try { await signInWithCustomToken(authInstance, initialAuthToken); }
                    catch (error) { await signInAnonymously(authInstance); }
                  } else { await signInAnonymously(authInstance); }
                }
                setIsAuthReady(true);
              });
            } catch (error) {
              console.error("Firebase init error:", error);
              setIsOffline(true);
              setIsAuthReady(true);
            }
          }, []);

          if (!isAuthReady) return <LoadingScreen />;
          if (isOffline) return <SprintDashboard isOffline={true} />;
          return (<div className="min-h-screen bg-gray-100 text-gray-800 font-sans">{user && db ? <SprintDashboard db={db} user={user} isOffline={false} /> : <AuthWall />}</div>);
        }

        function LoadingScreen() { return <div className="flex flex-col items-center justify-center h-screen bg-gray-100"><LoadingSpinner /><p className="text-xl text-gray-500 mt-4">Loading Sprint Tracker...</p></div>; }
        function AuthWall() { return <div className="flex flex-col items-center justify-center h-screen"><h1 className="text-3xl font-bold text-blue-600 mb-4">Sprint Tracker</h1><p className="text-gray-500">Connecting to services...</p><div className="mt-8"><LoadingSpinner /></div></div>; }
        function LoadingSpinner() { return <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>; }

        function SprintDashboard({ db, user, isOffline }) {
          const [sessions, setSessions] = useState([]);
          const [activeSessionId, setActiveSessionId] = useState(null);
          const [selectedSessions, setSelectedSessions] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [view, setView] = useState('logger');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);

          useEffect(() => {
            if (isOffline) {
              try {
                const parsedData = JSON.parse(localStorage.getItem('sprintSessions') || '[]');
                setSessions(parsedData);
                if (parsedData.length > 0) {
                    if(!activeSessionId) setActiveSessionId(parsedData[0].id);
                    if(selectedSessions.length === 0) setSelectedSessions([parsedData[0].id]);
                }
              } catch (e) { setSessions([]); }
              setIsLoading(false);
            } else {
              if (!db || !user) return;
              const { collection, query, onSnapshot } = window.firebase;
              const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sprint-tracker';
              const q = query(collection(db, `artifacts/${appId}/users/${user.uid}/sessions`));
              const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.date) - new Date(a.date));
                setSessions(data);
                 if (data.length > 0) {
                    if(!activeSessionId) setActiveSessionId(data[0].id);
                    if(selectedSessions.length === 0) setSelectedSessions([data[0].id]);
                }
                setIsLoading(false);
              }, (error) => { setIsLoading(false); });
              return () => unsubscribe();
            }
          }, [isOffline, db, user]);
          
          useEffect(() => { if (isOffline && !isLoading) { localStorage.setItem('sprintSessions', JSON.stringify(sessions)); }}, [sessions, isOffline, isLoading]);
          
          const handleCreateSession = async (name) => {
            const newSession = { name, date: new Date().toISOString(), sprints: [], id: Date.now().toString() };
             if (isOffline) { setSessions(prev => [newSession, ...prev].sort((a,b) => new Date(b.date) - new Date(a.date))); } 
             else {
                const { collection, addDoc } = window.firebase;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sprint-tracker';
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${user.uid}/sessions`), {...newSession, userId: user.uid});
                newSession.id = docRef.id;
            }
            setActiveSessionId(newSession.id);
            setSelectedSessions(prev => [newSession.id, ...prev].filter((v,i,a) => a.indexOf(v) === i));
            setView('logger');
            setIsCreateModalOpen(false);
          };

          const handleUpdateSession = async (sessionId, updatedData) => {
            if(isOffline) { setSessions(prev => prev.map(s => s.id === sessionId ? {...s, ...updatedData} : s)); } 
            else {
                const { doc, updateDoc } = window.firebase;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sprint-tracker';
                await updateDoc(doc(db, `artifacts/${appId}/users/${user.uid}/sessions`, sessionId), updatedData);
            }
          };

          const handleDeleteSession = async (sessionId) => {
             if (isOffline) { setSessions(prev => prev.filter(s => s.id !== sessionId)); } 
             else {
                const { doc, deleteDoc } = window.firebase;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sprint-tracker';
                await deleteDoc(doc(db, `artifacts/${appId}/users/${user.uid}/sessions`, sessionId));
            }
             if (activeSessionId === sessionId) setActiveSessionId(sessions.find(s => s.id !== sessionId)?.id || null);
             setSelectedSessions(prev => prev.filter(id => id !== sessionId));
          };

          const handleAddSprint = (sprintData) => {
             const session = sessions.find(s => s.id === activeSessionId);
             if (!session) return;
             const updatedSprints = [...(session.sprints || []), sprintData];
             handleUpdateSession(activeSessionId, {sprints: updatedSprints});
          };

          const handleUpdateSprint = (sprintToUpdate) => {
            const session = sessions.find(s => s.id === activeSessionId);
            if (!session) return;
            const updatedSprints = (session.sprints || []).map(s => s.id === sprintToUpdate.id ? sprintToUpdate : s);
            handleUpdateSession(activeSessionId, { sprints: updatedSprints });
          };
          
          const handleDeleteSprint = (sprintToDelete) => {
            const session = sessions.find(s => s.id === activeSessionId);
            if (!session) return;
            const updatedSprints = (session.sprints || []).filter(s => s.id !== sprintToDelete.id);
            handleUpdateSession(activeSessionId, { sprints: updatedSprints });
          };

          const handleSelectSession = (id) => { setActiveSessionId(id); setIsSidebarOpen(false); };
          
          const activeSession = sessions.find(s => s.id === activeSessionId);
          const MainContent = () => {
              switch(view) {
                  case 'calendar': return <CalendarPage sessions={sessions} onSessionSelect={handleSelectSession} setView={setView} />;
                  case 'analytics': return <PerformanceAnalytics sessions={sessions} selectedSessionIds={selectedSessions} onToggleSelection={(id) => setSelectedSessions(p => p.includes(id) ? p.filter(i => i !== id) : [...p, id])} onCreateSession={handleCreateSession} />;
                  case 'logger':
                  default: 
                    return activeSession ? <SprintLogger session={activeSession} onAddSprint={handleAddSprint} onUpdateSprint={handleUpdateSprint} onDeleteSprint={handleDeleteSprint}/> : <div className="flex flex-col items-center justify-center h-full text-center p-8 bg-white rounded-2xl shadow-sm"><Icon name="logIn" size={48} className="text-blue-500 mb-4" /><h2 className="text-2xl font-bold text-gray-800 mb-2">Welcome!</h2><p className="text-gray-500">Create or select a session to start.</p></div>;
              }
          }

          return (
            <div className="relative min-h-screen lg:flex">
                {isSidebarOpen && <div className="fixed inset-0 bg-black bg-opacity-50 z-10 lg:hidden" onClick={() => setIsSidebarOpen(false)}></div>}
                <aside className={`fixed top-0 left-0 h-full w-4/5 md:w-1/3 bg-gray-50/80 backdrop-blur-xl border-r border-gray-200 p-4 lg:p-6 flex flex-col scrollbar-thin transform transition-transform duration-300 ease-in-out z-20 lg:relative lg:w-1/3 lg:translate-x-0 lg:bg-gray-50 lg:border-r lg:border-gray-200 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                    <h1 className="text-2xl font-bold text-gray-900 mb-6">Sprint Tracker</h1>
                    {isLoading ? <LoadingSpinner /> : <SessionList sessions={sessions} activeSessionId={activeSessionId} onSelectSession={handleSelectSession} onUpdate={handleUpdateSession} onDelete={handleDeleteSession} />}
                    <div className="mt-auto pt-4 text-xs text-gray-400"><p>{isOffline ? "Offline Mode" : `User ID: ${user?.uid}`}</p></div>
                </aside>

                <main className="flex-1 p-4 lg:p-8 overflow-y-auto scrollbar-thin bg-white">
                    <header className="flex justify-between items-center mb-6">
                        <button onClick={() => setIsSidebarOpen(true)} className="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 lg:hidden"><Icon name="menu" size={24} /></button>
                         <div className="hidden lg:block w-10"></div>
                        <div className="bg-gray-200 p-1 rounded-full flex space-x-1">
                            <button onClick={() => setView('logger')} className={`px-4 py-1.5 text-sm sm:px-6 rounded-full font-semibold transition ${view === 'logger' ? 'bg-white shadow text-blue-600' : 'text-gray-600 hover:text-gray-900'}`}>Logger</button>
                            <button onClick={() => setView('calendar')} className={`px-4 py-1.5 text-sm sm:px-6 rounded-full font-semibold transition ${view === 'calendar' ? 'bg-white shadow text-blue-600' : 'text-gray-600 hover:text-gray-900'}`}>Calendar</button>
                            <button onClick={() => setView('analytics')} className={`px-4 py-1.5 text-sm sm:px-6 rounded-full font-semibold transition ${view === 'analytics' ? 'bg-white shadow text-blue-600' : 'text-gray-600 hover:text-gray-900'}`}>Analytics</button>
                        </div>
                        <button onClick={() => setIsCreateModalOpen(true)} className="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition"><Icon name="plus" size={24}/></button>
                    </header>
                    <MainContent />
                </main>
                {isCreateModalOpen && <SessionCreatorModal onCreateSession={handleCreateSession} onClose={() => setIsCreateModalOpen(false)} />}
            </div>
          );
        }

        function SessionCreatorModal({ onCreateSession, onClose }) {
          const [name, setName] = useState('');
          const [isSuggesting, setIsSuggesting] = useState(false);
          const handleSubmit = (e) => { e.preventDefault(); if(name.trim()){ onCreateSession(name.trim()); }};
          const handleSuggestName = async () => {
            setIsSuggesting(true);
            const suggestedName = await callGemini(`Suggest one creative and motivating name for a sprint training session. Be concise, just the name.`);
            setName(suggestedName.replace(/["*]/g, '').trim());
            setIsSuggesting(false);
          };
          return (<div className="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div className="bg-white border border-gray-200 rounded-2xl shadow-2xl p-6 w-full max-w-md">
                <form onSubmit={handleSubmit}>
                    <h3 className="text-xl font-bold mb-4 text-gray-900">Create New Session</h3>
                    <div className="flex items-center space-x-2">
                        <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Velocity Day" className="flex-grow bg-gray-100 text-gray-900 p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                        <button type="button" onClick={handleSuggestName} disabled={isSuggesting} className="p-3 bg-yellow-400 hover:bg-yellow-500 rounded-lg transition disabled:bg-gray-300 text-gray-800">{isSuggesting ? <div className="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-white"></div> : <Icon name="zap" size={24}/>}</button>
                    </div>
                    <div className="flex justify-end space-x-4 mt-6">
                        <button type="button" onClick={onClose} className="px-6 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 transition text-gray-800">Cancel</button>
                        <button type="submit" className="px-6 py-2 rounded-lg font-semibold bg-blue-600 hover:bg-blue-700 transition text-white">Create</button>
                    </div>
                </form>
            </div>
          </div>);
        }

        function SessionList({ sessions, activeSessionId, onSelectSession, onUpdate, onDelete}) {
            const [isOpen, setIsOpen] = useState(true);
            const [editingId, setEditingId] = useState(null);
            const [confirmDeleteId, setConfirmDeleteId] = useState(null);
            const handleUpdate = (id, newName) => { if(newName.trim()) onUpdate(id, { name: newName.trim() }); setEditingId(null); };
            return (
                <div className="flex-grow mt-6">
                    <div className="flex justify-between items-center text-left text-lg font-bold text-gray-900 mb-3"><button onClick={() => setIsOpen(!isOpen)} className="flex items-center text-gray-900">Sessions {isOpen ? <Icon name="chevronUp" className="ml-2" /> : <Icon name="chevronDown" className="ml-2" />}</button></div>
                    {isOpen && (<>
                        {sessions.length === 0 ? <p className="text-gray-500 text-center py-4">No sessions yet.</p> :
                        <ul className="space-y-2">
                            {sessions.map(session => <li key={session.id}>
                                {editingId === session.id ? (<div className="bg-white p-2 rounded-lg"><input type="text" defaultValue={session.name} autoFocus onBlur={(e) => handleUpdate(session.id, e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleUpdate(session.id, e.target.value)} className="w-full bg-gray-200 p-2 rounded-lg"/></div>) :
                                (<div className={`group w-full text-left p-3 rounded-xl transition flex justify-between items-center ${activeSessionId === session.id ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-200 text-gray-700'}`}><button onClick={() => onSelectSession(session.id)} className="flex-grow text-left"><p className="font-semibold">{session.name}</p><p className="text-xs text-gray-500">{new Date(session.date).toLocaleDateString()}</p></button><div className="flex opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => setEditingId(session.id)} className="p-1 hover:text-gray-900"><Icon name="edit" size={16}/></button><button onClick={() => setConfirmDeleteId(session.id)} className="p-1 hover:text-red-500"><Icon name="trash2" size={16}/></button></div></div>)}
                            </li>)}
                        </ul>}
                    </>)}
                    {confirmDeleteId && <ConfirmationModal title="Delete Session?" message="This action is permanent." onConfirm={() => { onDelete(confirmDeleteId); setConfirmDeleteId(null); }} onCancel={() => setConfirmDeleteId(null)} />}
                </div>
            );
        }
        
        function CalendarPage({sessions, onSessionSelect, setView}) {
            const [selectedDate, setSelectedDate] = useState(new Date());
            const sessionsOnDate = useMemo(() => sessions.filter(s => new Date(s.date).toDateString() === selectedDate.toDateString()), [sessions, selectedDate]);
            const handleSelectAndLog = (sessionId) => { onSessionSelect(sessionId); setView('logger'); };
            return (
                <div className="space-y-8">
                    <CalendarView sessions={sessions} selectedDate={selectedDate} onDateChange={setSelectedDate} />
                    <div>
                        <h3 className="text-xl font-bold text-gray-900 mb-4">Sessions on {selectedDate.toLocaleDateString()}</h3>
                        {sessionsOnDate.length > 0 ? (
                            <ul className="space-y-3">
                                {sessionsOnDate.map(session => (
                                    <li key={session.id} onClick={() => handleSelectAndLog(session.id)} className="bg-white p-4 rounded-xl cursor-pointer hover:bg-gray-50 transition border border-gray-200">
                                        <p className="font-semibold text-blue-600">{session.name}</p>
                                        <p className="text-sm text-gray-500">{session.sprints?.length || 0} sprints logged.</p>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                             <p className="text-gray-500 text-center py-8">No sessions on this day.</p>
                        )}
                    </div>
                </div>
            );
        }

        function CalendarView({ sessions, selectedDate, onDateChange }) {
            const [currentDate, setCurrentDate] = useState(new Date());
            const sessionDates = useMemo(() => new Set(sessions.map(s => new Date(s.date).toDateString())), [sessions]);
            const changeMonth = (amount) => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + amount, 1));
            const { month, year } = { month: currentDate.getMonth(), year: currentDate.getFullYear() };
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const blanks = Array.from({ length: firstDay });
            const weekDays = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            return (
                <div className="bg-white p-4 rounded-2xl border border-gray-200">
                    <div className="flex justify-between items-center mb-4"><button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-100 transition"><Icon name="chevronLeft" size={20} /></button><h3 className="font-bold text-lg text-gray-800">{new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate)}</h3><button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-100 transition"><Icon name="chevronRight" size={20} /></button></div>
                    <div className="grid grid-cols-7 gap-2 text-center text-xs text-gray-500">{weekDays.map((day, index) => <div key={index} className="font-semibold">{day}</div>)}</div>
                    <div className="grid grid-cols-7 gap-2 mt-2">
                        {blanks.map((_, i) => <div key={`b-${i}`} />)}
                        {days.map(day => {
                            const thisDate = new Date(year, month, day);
                            const isSelected = selectedDate && thisDate.toDateString() === selectedDate.toDateString();
                            const hasSession = sessionDates.has(thisDate.toDateString());
                            const baseClasses = "h-9 w-9 text-sm flex items-center justify-center rounded-full transition cursor-pointer relative";
                            const stateClasses = isSelected ? "bg-blue-600 text-white font-bold" : (thisDate.toDateString() === new Date().toDateString() ? "bg-gray-200" : "hover:bg-gray-100");
                            return <div key={day} className={`${baseClasses} ${stateClasses}`} onClick={() => onDateChange(thisDate)}>{day}{hasSession && <div className="absolute bottom-1.5 h-1.5 w-1.5 bg-blue-500 rounded-full" />}</div>;
                        })}
                    </div>
                </div>
            );
        }

        function SprintLogger({ session, onAddSprint, onUpdateSprint, onDeleteSprint }) {
          const [distance, setDistance] = useState(100);
          const [time, setTime] = useState('');
          const handleSubmit = (e) => { e.preventDefault(); const timeValue = parseFloat(time); if (!isNaN(timeValue) && timeValue > 0) { onAddSprint({ id: Date.now(), distance: Number(distance), time: timeValue }); setTime(''); } };
          return (
            <div className="bg-white p-4 sm:p-6 rounded-2xl">
              <h2 className="text-2xl sm:text-3xl font-bold mb-1 text-gray-900">{session.name}</h2>
              <p className="text-sm text-gray-500 mb-8">Date: {new Date(session.date).toLocaleDateString()}</p>
              <form onSubmit={handleSubmit} className="mb-8 p-4 sm:p-6 bg-gray-50 rounded-xl"><div className="grid md:grid-cols-2 gap-6 items-center"><div><label htmlFor="distance" className="block text-lg font-medium mb-2 text-gray-700">Distance: <span className="font-bold text-blue-600">{distance}m</span></label><input id="distance" type="range" min="20" max="400" step="10" value={distance} onChange={(e) => setDistance(e.target.value)} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-thumb"/></div><div className="flex items-end space-x-4"><div className="flex-grow"><label htmlFor="time" className="block text-lg font-medium mb-2 text-gray-700">Time (s)</label><input id="time" type="number" step="0.01" value={time} onChange={(e) => setTime(e.target.value)} placeholder="e.g., 12.54" className="w-full bg-white text-gray-900 p-3 rounded-lg border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none" required/></div><button type="submit" className="h-[52px] px-4 sm:px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition flex items-center justify-center"><Icon name="plus" size={24} /></button></div></div></form>
              <div><h3 className="text-xl font-bold mb-4 text-gray-800">Logged Sprints</h3><div className="max-h-96 overflow-y-auto pr-2 scrollbar-thin">{(session.sprints || []).length > 0 ? <ul className="space-y-3">{[...session.sprints].sort((a,b) => b.id - a.id).map(sprint => <SprintListItem key={sprint.id} sprint={sprint} onUpdate={onUpdateSprint} onDelete={onDeleteSprint} />)}</ul> : <p className="text-gray-500 text-center py-4">No sprints logged yet.</p>}</div></div>
            </div>
          );
        }

        function SprintListItem({ sprint, onUpdate, onDelete }) {
            const [isEditing, setIsEditing] = useState(false);
            const [confirmDelete, setConfirmDelete] = useState(false);
            const [editData, setEditData] = useState({ distance: sprint.distance, time: sprint.time });
            const handleSave = () => { const dist = parseInt(editData.distance, 10); const time = parseFloat(editData.time); if (!isNaN(dist) && !isNaN(time) && dist > 0 && time > 0) { onUpdate({ ...sprint, distance: dist, time: time }); setIsEditing(false); } };
            if (isEditing) { return (<li className="flex justify-between items-center bg-blue-50 p-3 rounded-lg"><div className="flex items-center gap-2"><input type="number" value={editData.distance} onChange={e => setEditData({...editData, distance: e.target.value})} className="w-20 bg-white p-1 rounded"/><span>m</span></div><div className="flex items-center gap-2"><input type="number" step="0.01" value={editData.time} onChange={e => setEditData({...editData, time: e.target.value})} className="w-24 bg-white p-1 rounded"/><span>s</span></div><div className="flex gap-2"><button onClick={handleSave} className="p-1 hover:text-green-500"><Icon name="save" size={16}/></button><button onClick={() => setIsEditing(false)} className="p-1 hover:text-red-500"><Icon name="x" size={16}/></button></div></li>); }
            return (<li className="group flex justify-between items-center bg-white p-4 rounded-xl transition-all border border-gray-200"><p className="font-semibold text-gray-800">{sprint.distance}m</p><p className="text-blue-600 text-lg font-mono">{sprint.time.toFixed(2)}s</p><div className="flex opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => setIsEditing(true)} className="p-1 hover:text-gray-900"><Icon name="edit" size={16}/></button><button onClick={() => setConfirmDelete(true)} className="p-1 hover:text-red-500"><Icon name="trash2" size={16}/></button></div>{confirmDelete && <ConfirmationModal title="Delete Sprint?" message={`Permanently delete the ${sprint.distance}m sprint?`} onConfirm={() => onDelete(sprint)} onCancel={() => setConfirmDelete(false)} />}</li>);
        }

        function PerformanceAnalytics({ sessions, selectedSessionIds, onToggleSelection, onCreateSession }) {
            const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts || {};
            if (!LineChart) { return (<div className="bg-white p-6 rounded-2xl"><h2 className="text-2xl font-bold mb-4 text-gray-900">Performance Analytics</h2><div className="h-96 w-full flex items-center justify-center"><LoadingSpinner /><p className="ml-4">Loading Chart Library...</p></div></div>); }
            const chartData = sessions.filter(s => selectedSessionIds.includes(s.id)).map(session => ({ name: session.name, data: (session.sprints || []).map(sp => ({ distance: sp.distance, time: sp.time })).sort((a,b) => a.distance - b.distance)}));
            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#22c55e', '#14b8a6', '#f59e0b'];
            return (
                <div className="space-y-8">
                    <div className="bg-white p-4 sm:p-6 rounded-2xl">
                        <h2 className="text-xl sm:text-2xl font-bold mb-4 text-gray-900">Performance Analytics</h2>
                        <div className="mb-8"><h3 className="text-lg font-semibold mb-3 text-gray-700">Compare Sessions</h3><div className="flex flex-wrap gap-2 sm:gap-3">{sessions.map(s => <button key={s.id} onClick={() => onToggleSelection(s.id)} className={`px-3 py-1.5 text-sm rounded-full font-semibold transition flex items-center space-x-2 ${selectedSessionIds.includes(s.id) ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>{selectedSessionIds.includes(s.id) && <Icon name="check" size={16}/>}<span>{s.name}</span></button>)}</div></div>
                        <div className="h-96 w-full">{chartData.length > 0 ? <ResponsiveContainer width="100%" height="100%"><LineChart margin={{ top: 5, right: 20, left: -10, bottom: 20 }}><CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" /><XAxis dataKey="distance" type="number" domain={['dataMin', 'dataMax']} label={{ value: 'Distance (m)', position: 'insideBottom', offset: -15, fill: '#6b7280' }} stroke="#9ca3af" tick={{ fill: '#6b7280' }}/><YAxis label={{ value: 'Time (s)', angle: -90, position: 'insideLeft', fill: '#6b7280', dx: -10 }} stroke="#9ca3af" tick={{ fill: '#6b7280' }}/><Tooltip contentStyle={{ backgroundColor: '#ffffff', borderColor: '#e5e7eb', borderRadius: '1rem', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)' }} labelStyle={{ fontWeight: 'bold', color: '#3b82f6' }}/><Legend wrapperStyle={{ paddingTop: '20px' }}/>{chartData.map((series, i) => <Line key={series.name} type="monotone" data={series.data} dataKey="time" name={series.name} stroke={colors[i % colors.length]} strokeWidth={2} dot={{ r: 4, fill: colors[i % colors.length] }} activeDot={{ r: 8 }}/>)}</LineChart></ResponsiveContainer> : <div className="flex items-center justify-center h-full"><p className="text-gray-500">Select sessions to see the chart.</p></div>}</div>
                    </div>
                    <AICoach comparisonData={sessions.filter(s => selectedSessionIds.includes(s.id))} />
                    <AIWorkoutPlanner recentSession={sessions.length > 0 ? sessions[0] : null} onCreateSession={onCreateSession} />
                </div>
            );
        }
        
        function AICoach({ comparisonData }) {
            const [analysis, setAnalysis] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const handleGetAnalysis = async () => {
                setIsLoading(true); setAnalysis('');
                const dataSummary = comparisonData.map(s => `Session "${s.name}" on ${new Date(s.date).toLocaleDateString()}: [${(s.sprints||[]).map(sp => `${sp.distance}m in ${sp.time.toFixed(2)}s`).join(', ') || 'No sprints'}]`).join('\n');
                if (!dataSummary.trim()) { setAnalysis("No data to analyze."); setIsLoading(false); return; }
                const prompt = `You are a world-class sprinting coach. Analyze the following data, providing concise, actionable, and encouraging analysis. Focus on trends, improvements, or areas needing work. Compare sessions. Format as markdown (headings, lists, bold). Here is the data:\n${dataSummary}`;
                setAnalysis(await callGemini(prompt)); setIsLoading(false);
            };
            const renderMarkdown = (text) => {
                if (!text) return null;
                const html = text.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-blue-500 mt-4 mb-2">$1</h3>').replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-blue-600 mt-6 mb-3">$1</h2>').replace(/^# (.*$)/gim, '<h1 class="text-2xl font-extrabold text-blue-700 mt-8 mb-4">$1</h1>').replace(/\*\*(.*)\*\*/gim, '<strong class="font-bold text-gray-900">$1</strong>').replace(/\*(.*)\*/gim, '<em>$1</em>').replace(/^\* (.*$)/gim, '<li class="ml-6 list-disc">$1</li>').replace(/\n/g, '<br />');
                return <div className="prose" dangerouslySetInnerHTML={{ __html: html.replace(/<br \/><li/g, '<li').replace(/(<\/li>)<br \/>/g, '$1') }} />;
            };
            return (
                <div className="bg-white p-4 sm:p-6 rounded-2xl"><h2 className="text-xl sm:text-2xl font-bold mb-4 text-gray-900 flex items-center"><Icon name="zap" size={24} className="mr-3 text-yellow-400"/>AI Performance Coach</h2><p className="text-gray-500 mb-6">Get personalized feedback on your selected training sessions.</p><button onClick={handleGetAnalysis} disabled={isLoading || comparisonData.length === 0} className="w-full bg-yellow-400 hover:bg-yellow-500 disabled:bg-gray-300 disabled:cursor-not-allowed text-gray-800 font-bold py-3 px-4 rounded-lg transition flex items-center justify-center mb-6">{isLoading ? <LoadingSpinner /> : <span className="flex items-center">✨ Analyze My Performance</span>}</button>{analysis && <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">{renderMarkdown(analysis)}</div>}</div>
            );
        }

        function AIWorkoutPlanner({ recentSession, onCreateSession }) {
            const [plan, setPlan] = useState('');
            const [planTitle, setPlanTitle] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const handleGeneratePlan = async () => {
                setIsLoading(true); setPlan(''); setPlanTitle('');
                const dataSummary = `Session "${recentSession.name}" on ${new Date(recentSession.date).toLocaleDateString()}: [${(recentSession.sprints||[]).map(sp => `${sp.distance}m in ${sp.time.toFixed(2)}s`).join(', ') || 'No sprints'}]`;
                const prompt = `You are a world-class sprinting coach. Based on the last training session's data, create a plan for the next one. The plan should be structured with a warm-up, main set, and cool-down. The first line of your response must be a creative title for this new session, formatted as "Title: [Your Title]". The rest of the response should be the plan in markdown. Last session data:\n${dataSummary}`;
                const result = await callGemini(prompt);
                const firstLineEnd = result.indexOf('\n');
                const titleLine = result.substring(0, firstLineEnd);
                const planBody = result.substring(firstLineEnd + 1).trim();
                setPlanTitle(titleLine.startsWith("Title:") ? titleLine.replace("Title:", "").trim() : "AI Generated Workout");
                setPlan(planBody);
                setIsLoading(false);
            };

            const handleCreateSessionFromPlan = () => { if (planTitle) onCreateSession(planTitle); };
            const renderMarkdown = (text) => {
                if (!text) return null;
                const html = text.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-blue-500 mt-4 mb-2">$1</h3>').replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-blue-600 mt-6 mb-3">$1</h2>').replace(/^# (.*$)/gim, '<h1 class="text-2xl font-extrabold text-blue-700 mt-8 mb-4">$1</h1>').replace(/\*\*(.*)\*\*/gim, '<strong class="font-bold text-gray-900">$1</strong>').replace(/\*(.*)\*/gim, '<em>$1</em>').replace(/^\* (.*$)/gim, '<li class="ml-6 list-disc">$1</li>').replace(/\n/g, '<br />');
                return <div className="prose" dangerouslySetInnerHTML={{ __html: html.replace(/<br \/><li/g, '<li').replace(/(<\/li>)<br \/>/g, '$1') }} />;
            };
            return (
                <div className="bg-white p-4 sm:p-6 rounded-2xl"><h2 className="text-xl sm:text-2xl font-bold mb-4 text-gray-900 flex items-center"><Icon name="brainCircuit" size={24} className="mr-3 text-pink-500"/>AI Workout Planner</h2><p className="text-gray-500 mb-6">Generate your next workout based on your most recent performance.</p><button onClick={handleGeneratePlan} disabled={isLoading || !recentSession} className="w-full bg-pink-500 hover:bg-pink-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center mb-6">{isLoading ? <LoadingSpinner /> : <span className="flex items-center">✨ Generate Next Workout</span>}</button>{plan && <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">{renderMarkdown(`# ${planTitle}\n\n${plan}`)}<button onClick={handleCreateSessionFromPlan} className="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center"><Icon name="plus" size={20} className="mr-2"/> Create This Session</button></div>}</div>
            );
        }

        function ConfirmationModal({ title, message, onConfirm, onCancel }) {
            return (<div className="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div className="bg-white border border-gray-200 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center"><Icon name="alertTriangle" size={48} className="mx-auto text-red-500 mb-4" /><h3 className="text-xl font-bold text-gray-900 mb-2">{title}</h3><p className="text-gray-500 mb-6">{message}</p><div className="flex justify-center space-x-4"><button onClick={onCancel} className="px-6 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 transition">Cancel</button><button onClick={onConfirm} className="px-6 py-2 rounded-lg font-semibold bg-red-600 hover:bg-red-700 text-white transition">Confirm</button></div></div></div>);
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
